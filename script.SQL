CREATE TABLE USER (
    ID_USER INTEGER PRIMARY KEY AUTO_INCREMENT,
    USER_NAME VARCHAR(150) UNIQUE,
    SENHA VARCHAR(200) CHECK (LENGTH(SENHA) > 6),
    CONTATO1 VARCHAR(200),
    CONTATO2 VARCHAR(200),
    ESTADO VARCHAR(100),
    CIDADE VARCHAR(100),
    BAIRRO VARCHAR(100),
    RUA VARCHAR(100),
    NUMERO VARCHAR(10),
    COMPLEMENTO VARCHAR(100)
);

CREATE TABLE MESTRE (
	ID_MESTRE INTEGER PRIMARY KEY,
	NPC VARCHAR(300),
	MONSTRO VARCHAR(300),
	FOREIGN KEY(ID_MESTRE) REFERENCES USER(ID_USER)
);

ALTER table MESTRE
RENAME COLUMN ID_MESTRE TO FK_ID_USER;

CREATE TABLE JOGADOR (
	ID_JOGADOR INTEGER PRIMARY KEY,
	FOREIGN KEY(ID_JOGADOR) REFERENCES USER(ID_USER)
);

CREATE TABLE PERSONAGEM (
    ID_PERSONAGEM INTEGER PRIMARY KEY,
    NOME VARCHAR(100),
    CLASSE VARCHAR(50),
    NIVEL INTEGER,
    HABILIDADES VARCHAR(1000),
    BACKSTORY VARCHAR(3000),
    ID_JOGADOR INTEGER,
    FOREIGN KEY (ID_JOGADOR) REFERENCES JOGADOR(ID_JOGADOR) ON DELETE CASCADE
);

# Caso um jogador seja deletado, todos os seus personagens são deletados também
ALTER TABLE JOGADOR
ADD CONSTRAINT FK_JOGADOR_PERSONAGEM
FOREIGN KEY (ID_JOGADOR) REFERENCES PERSONAGEM(ID_JOGADOR) ON DELETE CASCADE;

CREATE TABLE HISTORIA (
    ID_HISTORIA INTEGER PRIMARY KEY,
    NOME VARCHAR (100),
    PROLOGO VARCHAR (2000),
    QTD_JOGADORES INTEGER,
    DT_INICIO DATE,
    PRESENCIAL BOOL DEFAULT FALSE,
    ID_MESTRE INTEGER,
    # Caso um mestre seja deletado, todas as suas histórias são deletadas também
    FOREIGN KEY (ID_MESTRE) REFERENCES MESTRE (ID_MESTRE) ON DELETE CASCADE
);

CREATE TABLE PARTICIPACAO (
	ID_PERSONAGEM INTEGER,
	ID_MESTRE INTEGER,
	ID_HISTORIA INTEGER,
	PRIMARY KEY(ID_PERSONAGEM, ID_MESTRE, ID_HISTORIA),
	FOREIGN KEY (ID_PERSONAGEM) REFERENCES PERSONAGEM (ID_PERSONAGEM),
	FOREIGN KEY (ID_MESTRE, ID_HISTORIA) REFERENCES HISTORIA (ID_MESTRE, ID_HISTORIA)
);

CREATE TABLE PRODUTO (
	ID_PRODUTO INTEGER PRIMARY KEY,
	NOME_PRODUTO VARCHAR(100),
	DESCRICAO VARCHAR(500),
	PRECO DOUBLE
);

CREATE TABLE DADO (
	ID_DADO INTEGER PRIMARY KEY,
	QTD_LADOS INTEGER,
	FOREIGN KEY (ID_DADO) REFERENCES PRODUTO (ID_PRODUTO)
);

ALTER TABLE DADO
RENAME COLUMN ID_DADO TO FK_ID_PRODUTO;

CREATE TABLE LIVRO (
	ID_LIVRO INTEGER PRIMARY KEY,
	QTD_PAGINAS INTEGER,
	ESTADO DOUBLE,
	FOREIGN KEY (ID_LIVRO) REFERENCES PRODUTO (ID_PRODUTO)
);

ALTER TABLE LIVRO
RENAME COLUMN ID_LIVRO TO FK_ID_PRODUTO;

CREATE TABLE VENDA (
    ID_VENDA INTEGER PRIMARY KEY,
    ID_PRODUTO INTEGER,
    ID_USER INTEGER,
    DATA_VENDA DATE,
    FOREIGN KEY (ID_PRODUTO) REFERENCES PRODUTO(ID_PRODUTO),
    FOREIGN KEY (ID_USER) REFERENCES USER(ID_USER)
);

CREATE TABLE COMPRA (
    ID_COMPRA INTEGER PRIMARY KEY,
    ID_PRODUTO INTEGER,
    ID_USER INTEGER,
    DATA_COMPRA DATE,
    FOREIGN KEY (ID_PRODUTO) REFERENCES PRODUTO(ID_PRODUTO),
    FOREIGN KEY (ID_USER) REFERENCES USER(ID_USER)
);
